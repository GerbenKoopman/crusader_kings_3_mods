dub_squire_interaction = {
	category = interaction_category_vassal
	icon = icon_vassal
	desc = dub_squire_interaction_desc

	auto_accept = yes

	is_shown = {
		scope:actor = {
			can_dub_knights_trigger = yes
		}
		scope:recipient = {
			# Must be either a vassal OR a courtier
			OR = {
				is_courtier_of = scope:actor
				is_vassal_or_below_of = scope:actor
				liege = { is_vassal_or_below_of = scope:actor }
			}
			# Must be of noble birth
			is_lowborn = no
		}
		NOT = { scope:recipient = scope:actor }
	}

	is_valid_showing_failures_only = {
		scope:recipient = {
			can_be_dubbed_knight_trigger = yes
			scope:recipient.faith = scope:actor.faith
		}
	}

	on_accept = {
		scope:actor = {
			add_prestige = -50
		}
		scope:recipient = {
			# Grant the trait
			add_trait = dubbed_knight
			add_character_flag = dubbed_knight_flag
			
			# Grant the titular knightly title
			custom_tooltip = {
				text = knight_grant_title_tt
				knight_grant_titular_title_effect = { GRANTOR = scope:actor }
			}
			
			add_prestige = 100
			add_opinion = {
				target = scope:actor
				modifier = dubbed_my_knight_modifier
			}
			
			# Create vassal relationship if they're a courtier
			if = {
				limit = {
					is_courtier_of = scope:actor
				}
				create_title_and_vassal_change = {
					type = swear_fealty
					save_scope_as = change
				}
				change_liege = {
					liege = scope:actor
					change = scope:change
				}
				resolve_title_and_vassal_change = scope:change
			}
			
			# House knightly legacy tracking
			house = {
				change_variable = {
					name = knights_provided_to_liege
					add = 1
				}
				if = {
					limit = {
						NOT = { has_house_modifier = knightly_house_modifier }
						var:knights_provided_to_liege >= 5
					}
					add_house_modifier = knightly_house_modifier
					house_head = {
						trigger_event = { id = knight_legacy_events.0003 }
					}
				}
			}
		}
	}
	
	cost = {
		prestige = 100
		piety = 25
	}
	
	ai_frequency = 12
	ai_target_quick_trigger = {
		adult = yes
	}
	ai_targets = {
		ai_recipients = courtiers
		max = 10
	}
	ai_will_do = {
		base = 10
		
		modifier = {
			add = 20
			scope:recipient = {
				OR = {
					has_relation_friend = scope:actor
					has_relation_best_friend = scope:actor
				}
			}
		}
		modifier = {
			add = 10
			scope:recipient = {
				prowess >= 12
			}
		}
		modifier = {
			add = -50
			scope:recipient = {
				prowess < 8
			}
		}
	}
}

request_knighthood_interaction = {
	category = interaction_category_vassal
	icon = icon_vassal
	desc = request_knighthood_interaction_desc

	is_shown = {
		scope:actor = {
			is_vassal_or_below_of = scope:recipient
			is_lowborn = no
		}
		scope:recipient = {
			can_dub_knights_trigger = yes
		}
		NOT = { scope:recipient = scope:actor }
	}

	is_valid = {
		scope:actor = {
			can_be_dubbed_knight_trigger = yes
			prestige >= 50
		}
		scope:recipient = {
			is_ruler = yes
			opinion = {
				target = scope:actor
				value > 0
			}
		}
	}

	on_accept = {
		scope:actor = {
			add_prestige = -50
			add_trait = dubbed_knight
			add_character_flag = dubbed_knight_flag
			
			# Grant the titular knightly title
			custom_tooltip = {
				text = knight_grant_title_tt
				knight_grant_titular_title_effect = { GRANTOR = scope:recipient }
			}
			
			add_prestige = 100
			
			# Create vassal relationship if they're a courtier
			if = {
				limit = {
					is_courtier_of = scope:recipient
				}
				create_title_and_vassal_change = {
					type = swear_fealty
					save_scope_as = change
				}
				change_liege = {
					liege = scope:recipient
					change = scope:change
				}
				resolve_title_and_vassal_change = scope:change
			}
			
			# House knightly legacy tracking
			house = {
				change_variable = {
					name = knights_provided_to_liege
					add = 1
				}
				if = {
					limit = {
						NOT = { has_house_modifier = knightly_house_modifier }
						var:knights_provided_to_liege >= 5
					}
					add_house_modifier = knightly_house_modifier
					house_head = {
						trigger_event = { id = knight_legacy_events.0003 }
					}
				}
			}
		}
		scope:recipient = {
			add_prestige = -50
			add_opinion = {
				target = scope:actor
				modifier = dubbed_my_knight_modifier
			}
		}
	}

	on_decline = {
		scope:actor = {
			add_opinion = {
				target = scope:recipient
				modifier = refused_knighthood_modifier
			}
		}
	}

	cooldown = { years = 5 }

	ai_accept = {
		base = 0
		
		modifier = {
			add = 20
			scope:actor = {
				prowess >= 12
			}
			desc = SKILLED_WARRIOR_REASON
		}
		modifier = {
			add = 10
			scope:actor = {
				martial >= 10
			}
			desc = MARTIAL_SKILL_REASON
		}
		opinion_modifier = {
			who = scope:recipient
			opinion_target = scope:actor
			multiplier = 0.5
			desc = AI_OPINION_REASON
		}
	}

	ai_will_do = {
		base = 1
		modifier = {
			factor = 2
			scope:recipient = {
				opinion = {
					target = scope:actor
					value > 50
				}
			}
		}
		modifier = {
			factor = 0.5
			scope:actor = {
				prestige < 200
			}
		}
	}
}

