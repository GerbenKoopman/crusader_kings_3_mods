dub_squire_interaction = {
	category = interaction_category_vassal
	icon = "gfx/interface/icons/character_interactions/interaction_knight.dds" # A valid vanilla icon

	is_shown = {
		scope:actor = { is_ruler = yes }
		scope:recipient = {
			is_vassal_or_below = scope:actor
			# Show for Squires and Masters who could be granted a manor and dubbed
			OR = {
				is_manorial_lord = yes
				AND = {
					is_lowborn = no
					is_knight = no
					has_landed_title = no
				}
			}
		}
	}

	is_valid_showing_failures_only = {
		scope:actor = { prestige >= 150 }
		scope:recipient = {
			is_adult = yes
			is_alive = yes
			is_imprisoned = no
			NOT = { has_trait = trait_dubbed_knight }
			# Must either be a manorial lord OR you need to have an ungranted manor to give them.
			# This part is complex to script directly in the interaction validity.
			# For simplicity, we assume the player will grant the manor first if needed.
			# The interaction is primarily for dubbing existing Manorial Lords ('Squires').
			is_manorial_lord = yes
		}
	}

	on_accept = {
		scope:actor = {
			add_prestige = -150
		}
		scope:recipient = {
			add_trait = trait_dubbed_knight
			add_opinion = {
				modifier = dubbed_my_knight_modifier
				target = scope:actor
			}
			# This is where we add to the House variable
			house = {
				change_variable = {
					name = knights_provided_to_liege
					add = 1
				}
				# Check if the House is now eligible for the modifier
				if = {
					limit = {
						NOT = { has_house_modifier = knightly_house_modifier }
						var:knights_provided_to_liege >= 5
					}
					add_house_modifier = knightly_house_modifier
					house_head = {
						trigger_event = { id = knight_legacy_events.0003 } # Notification
					}
				}
			}
		}
	}

	localization = "dub_squire_interaction"
}

request_knighthood_interaction = {
	category = interaction_category_vassal
	icon = "gfx/interface/icons/character_interactions/interaction_knight.dds"

	is_shown = {
		scope:actor = {
			is_vassal_or_below = scope:recipient
		}
		scope:recipient = {
			is_ruler = yes
		}
	}

	is_valid = {
		scope:actor = {
			prestige >= 150
			is_adult = yes
			is_alive = yes
			is_imprisoned = no
			NOT = { has_trait = trait_dubbed_knight }
			# Replaced can_fight with the scripted trigger for combatant eligibility
			OR = {
				# Option A: Allowed by Faith/Culture laws
				can_be_combatant_based_on_gender_trigger = {
					ARMY_OWNER = scope:actor
					PROSPECTIVE_COMBATANT = scope:recipient
				}
				# Option B: Has Shieldmaiden trait
				has_trait = shieldmaiden
			}
		}
		scope:recipient = {
			is_ruler = yes
			opinion = {
				target = scope:actor
				value > 0
			}
		}
	}

	on_accept = {
		scope:actor = {
			add_prestige = -150
			add_trait = trait_dubbed_knight
		}
		scope:recipient = {
			add_opinion = {
				modifier = dubbed_my_knight_modifier
				target = scope:actor
			}
		}
	}

	on_decline = {
		scope:actor = {
			add_opinion = {
				modifier = refused_knighthood_modifier
				target = scope:recipient
			}
		}
	}

	cooldown = { years = 5 }

	ai_will_do = {
		base = 1 # Base chance for AI to consider the interaction
		modifier = {
			factor = 2
			scope:recipient = {
				opinion = {
					target = scope:actor
					value > 50 # Higher chance if the liege has a high opinion of the requester
				}
			}
		}
		modifier = {
			factor = 0.5
			scope:actor = {
				prestige < 200 # Lower chance if the requester has low prestige
			}
		}
	}

	localization = "request_knighthood_interaction"
}
