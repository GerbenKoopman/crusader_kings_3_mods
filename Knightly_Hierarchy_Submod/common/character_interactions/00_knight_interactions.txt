dub_squire_interaction = {
	category = interaction_category_vassal

	is_shown = {
		scope:actor = {
			OR = {
				# 1. Any Duke, King, or Emperor is valid (even if unlanded)
				tier >= tier_duchy
				
				# 2. Counts are ONLY valid if they actually hold land
				AND = {
					tier = tier_county
					is_landed = yes
				}
			}
		}
		scope:recipient = {
			
			# --- RELATIONSHIP CHECK ---
			# Must be either a vassal OR a courtier of a vassal
			OR = {
				is_courtier_of = scope:actor                    # MY courtiers
				is_vassal_or_below_of = scope:actor             # MY vassals
				liege = { is_vassal_or_below_of = scope:actor } # THEIR courtiers
			}

			# --- ELIGIBILITY CHECK ---
			is_lowborn = no
		}
	}

	on_accept = {
		scope:actor = {
			add_prestige = -50
		}
		scope:recipient = {
			add_trait = trait_dubbed_knight
			add_character_flag = dubbed_knight_flag
			add_opinion = {
				target = scope:actor
				modifier = dubbed_my_knight_modifier
			}
			# This is where we add to the House variable
			house = {
				change_variable = {
					name = knights_provided_to_liege
					add = 1
				}
				# Check if the House is now eligible for the modifier
				if = {
					limit = {
						NOT = { has_house_modifier = knightly_house_modifier }
						var:knights_provided_to_liege >= 5
					}
					add_house_modifier = knightly_house_modifier
					house_head = {
						trigger_event = { id = knight_legacy_events.0003 } # Notification
					}
				}
			}
		}
	}
}

request_knighthood_interaction = {
	category = interaction_category_vassal

	is_shown = {
		scope:actor = {
			is_vassal_or_below_of = scope:recipient
		}
		scope:recipient = {
			OR = {
				# 1. Any Duke, King, or Emperor is valid (even if unlanded)
				tier >= tier_duchy
				
				# 2. Counts are ONLY valid if they actually hold land
				AND = {
					tier = tier_county
					is_landed = yes
				}
			}
		}
	}

	is_valid = {
		scope:actor = {
			prestige >= 50
			is_adult = yes
			is_alive = yes
			is_imprisoned = no
			NOT = { has_trait = trait_dubbed_knight }
			OR = {
				can_be_combatant_based_on_gender_trigger = {
					ARMY_OWNER = scope:actor
				}
				has_trait = shieldmaiden
			}
		}
		scope:recipient = {
			is_ruler = yes
			opinion = {
				target = scope:actor
				value > 0
			}
		}
	}

	on_accept = {
		scope:actor = {
			add_prestige = -50
			add_trait = trait_dubbed_knight
			add_character_flag = dubbed_knight_flag
		}
		scope:recipient = {
			add_opinion = {
				target = scope:actor
				modifier = dubbed_my_knight_modifier
			}
		}
	}

	on_decline = {
		scope:actor = {
			add_opinion = {
				target = scope:recipient
				modifier = refused_knighthood_modifier
			}
		}
	}

	cooldown = { years = 5 }

	ai_will_do = {
		base = 1 # Base chance for AI to consider the interaction
		modifier = {
			factor = 2
			scope:recipient = {
				opinion = {
					target = scope:actor
					value > 50 # Higher chance if the liege has a high opinion of the requester
				}
			}
		}
		modifier = {
			factor = 0.5
			scope:actor = {
				prestige < 200 # Lower chance if the requester has low prestige
			}
		}
	}
}

