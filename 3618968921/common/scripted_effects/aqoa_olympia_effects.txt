aqoa_gold_to_xp_adjustment = {
	if = {
		limit = {
			NOT = { has_game_rule = aqoa_income_XP_100 }
		}
		
		if = {
			limit = { has_game_rule = aqoa_income_XP_75 }
			change_variable = { name = aqoa_monthly_income multiply = 0.75 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_income_XP_50 }
			change_variable = { name = aqoa_monthly_income multiply = 0.5 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_income_XP_25 }
			change_variable = { name = aqoa_monthly_income multiply = 0.25 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_income_XP_10 }
			change_variable = { name = aqoa_monthly_income multiply = 0.10 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_income_XP_125 }
			change_variable = { name = aqoa_monthly_income multiply = 1.25 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_income_XP_150 }
			change_variable = { name = aqoa_monthly_income multiply = 1.5 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_income_XP_175 }
			change_variable = { name = aqoa_monthly_income multiply = 1.75 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_income_XP_200 }
			change_variable = { name = aqoa_monthly_income multiply = 2.0 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_income_XP_200 }
			change_variable = { name = aqoa_monthly_income multiply = 3.0 }
		}
	}
}

aqoa_tribal_xp_adjustment = {
	if = {
        limit = {
            OR = {
                government_has_flag = government_is_tribal
                government_has_flag = government_is_nomad
                government_has_flag = government_is_wanua
				government_has_flag = government_is_landless_adventurer
				government_has_flag = government_is_mercenary
            }
        }
        if = {
			limit = { has_game_rule = aqoa_tribal_33 }
			change_variable = { name = aqoa_monthly_income divide = 3 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_tribal_10 }
			change_variable = { name = aqoa_monthly_income multiply = 0.1 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_tribal_25 }
			change_variable = { name = aqoa_monthly_income multiply = 0.25 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_tribal_50 }
			change_variable = { name = aqoa_monthly_income multiply = 0.50 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_tribal_75 }
			change_variable = { name = aqoa_monthly_income multiply = 0.75 }
		}
		else_if = {
			limit = { has_game_rule = aqoa_tribal_100 }
			change_variable = { name = aqoa_monthly_income multiply = 0.100 }
		}
    }
}

aqoa_calculate_income_rulers = {
    if = {
        limit = { 
            NOT = { 
                has_trait = olympia_class_tier
            }
        }
        add_trait = olympia_class_tier
    }
    
	save_scope_as = host
	
	#Clear the variable to clean it up
    remove_variable = aqoa_monthly_income
	remove_variable = aqoa_personal_gold
	remove_character_flag = olympia_income_dependent

	every_courtier_or_guest = {
		set_variable = { name = aqoa_monthly_income value = 0 }
		remove_character_flag = olympia_income_dependent
	}
	
    set_variable = { name = aqoa_monthly_income value = 0 }
    
    # Tier bonuses if game rule is enabled
    if = {
		limit = { NOT = { has_game_rule = aqoa_safety_nets_off } }
		if = {
			limit = { 
				highest_held_title_tier = tier_county
			}
			change_variable = { name = aqoa_monthly_income add = 10 }
			add_character_flag = {
				flag = income_check_cooldown
				years = 3
			}
		}
		else_if = {
			limit = {
				highest_held_title_tier = tier_duchy
				NOR = {
					primary_title = { is_mercenary_company = yes }
					has_government = landless_adventurer_government
				}
			}
			change_variable = { name = aqoa_monthly_income add = 20 }
			add_character_flag = {
				flag = income_check_cooldown
				years = 2
			}
		}
		else_if = {
			limit = {
				highest_held_title_tier = tier_kingdom
			}
			change_variable = { name = aqoa_monthly_income add = 30 }
		}
		else_if = {
			limit = {
				highest_held_title_tier >= tier_empire
			}
			change_variable = { name = aqoa_monthly_income add = 40 }
		}
		else_if = {
			limit = {
				highest_held_title_tier >= tier_hegemony
			}
			change_variable = { name = aqoa_monthly_income add = 50 }
		}
		else = {
			add_character_flag = {
				flag = income_check_cooldown
				years = 5
			}
		}
	}
	
	if = {
		limit = { has_game_rule = aqoa_safety_nets_half }
		change_variable = { name = aqoa_monthly_income multiply = 0.5 }
	}
    
	#Now let's take a look at savings! Pool if spouse has some too.
	if = {
		limit = {
			OR = {
				gold >= 100
				any_spouse = {
					gold >= 100
				}
			}
		}
		set_variable = { name = aqoa_personal_gold value = gold }
		change_variable = { name = aqoa_personal_gold divide = 100 }
		
		# Check if spouse has gold to contribute
		if = {
			limit = {
				any_spouse = {
					gold >= 100
				}
			}
			random_spouse = {
				limit = { gold > 9 }
				save_scope_as = spouse_gold
			}
			# Calculate spouse's gold contribution separately
			set_variable = {
				name = aqoa_spouse_contribution
				value = scope:spouse_gold.gold
			}
			change_variable = {
				name = aqoa_spouse_contribution
				divide = 100
			}
			# Add spouse's contribution to our personal gold
			change_variable = { 
				name = aqoa_personal_gold 
				add = var:aqoa_spouse_contribution
			}
		}
		
		change_variable = { name = aqoa_monthly_income add = var:aqoa_personal_gold }
	}
	
	#Now check for income
	change_variable = { name = aqoa_monthly_income add = monthly_character_income }
    change_variable = { name = aqoa_monthly_income subtract = monthly_character_expenses }
	
	#Gold to XP Adjustment
	aqoa_gold_to_xp_adjustment = yes
	
    # Government type modifier
    aqoa_tribal_xp_adjustment = yes
    
    # Apply XP
    add_trait_xp = { trait = olympia_class_tier value = -100 }
    while = {
        count = 100
		limit = {
            has_trait_xp = { trait = olympia_class_tier value < var:aqoa_monthly_income }
        }
        add_trait_xp = { trait = olympia_class_tier value = 1 }
    }

	#Now apply the trait to all courtiers
	every_courtier_or_guest = {
		limit = {
			NOT = { 
                has_trait = olympia_class_tier
            }
		}
		add_trait = olympia_class_tier
	}
	
	#Now let's look for family to support
	every_courtier_or_guest = {	#Loop 1
		olympia_calculate_other_income = yes
	}
	
	every_courtier_or_guest = {	#Loop 2
		olympia_calculate_dependent_income = yes
	}
}

olympia_calculate_other_income = {
	
	#Look for family, wards, or friends to support
	if = {
		limit = {
			OR = {
				is_spouse_of = scope:host
				is_close_or_extended_family_of = scope:host
				has_relation_best_friend = scope:host
				is_hostage = yes
				any_relation = {
					type = guardian
					this = scope:host
				}
				any_relation = {
					type = friend
					this = scope:host
				}
				AND = {
					OR = {
						government_has_flag = government_is_mercenary
						government_has_flag = government_is_landless_adventurer
					}
					is_courtier_of = scope:host
				}
			}
		}
		
		add_character_flag = olympia_income_dependent
		
		set_variable = { name = aqoa_monthly_income 	value = scope:host.var:aqoa_monthly_income }		#Set variable
		
		#Concubines, bastards, and disinherited only get 1/3 of the dependent income
		if = {
			limit = {
				OR = {
					is_concubine = yes
					has_trait = bastard
					has_trait = disinherited
				}
			}
			change_variable = {
				name = aqoa_monthly_income
				divide = 3
			}
		}
		
		#Extended family, friends, and wards only get 75% of the dependent income (camps and followers share)
		if = {
			limit = {
				NOR = {
					is_close_family_of = scope:host			#Covers parents, children, uncles, aunts, grandparents, grandchildren
					is_spouse_of = scope:host				#Happy spouse, happy life
					has_relation_best_friend = scope:host 	#Rulers always help their besties out
					is_hostage = yes
					AND = {
						OR = {
							government_has_flag = government_is_mercenary
							government_has_flag = government_is_landless_adventurer
						}
						is_courtier_of = scope:host
					}
				}
			}
			change_variable = {
				name = aqoa_monthly_income
				multiply = 0.75
			}
		}
	}
	
	#Now let's look at everyone else working for the ruler and pay them
	if = {
		limit = {
			NOT = { has_character_flag = olympia_income_dependent }
		}

		#Does your spouse have any coin they can contribute?
		if = {
			limit = { is_married = yes }
			
			save_scope_as = primary_spouse
			
			if = {
				limit = {
					any_spouse = {
						gold >= 10
						is_female = yes
						NOT = { faith = { has_doctrine = doctrine_gender_female_dominated } }
					}
				}
				random_spouse = {
					limit = {
						gold >= 10
						is_female = yes
						NOT = { faith = { has_doctrine = doctrine_gender_female_dominated } }
					}
					set_variable = { name = spouse_gold_to_give value = gold }
					pay_short_term_gold = {
						target = scope:primary_spouse
						gold = var:spouse_gold_to_give
					}
					remove_variable = spouse_gold_to_give
				}
			}
			else_if = {
				limit = {
					any_spouse = {
						gold >= 10
						is_female = no
						faith = { has_doctrine = doctrine_gender_female_dominated }
					}
				}
				random_spouse = {
					limit = {
						gold >= 10
						is_female = no
						faith = { has_doctrine = doctrine_gender_female_dominated }
					}
					set_variable = { name = spouse_gold_to_give value = gold }
					pay_short_term_gold = {
						target = scope:primary_spouse
						gold = var:spouse_gold_to_give
					}
					remove_variable = spouse_gold_to_give
				}
			}
		}
		
		#Now let's look at your total coin value
		if = {
			limit = {
				gold >= 10
			}
			set_variable = { name = aqoa_personal_gold value = gold }
			change_variable = { name = aqoa_personal_gold divide = 100 }
			change_variable = { name = aqoa_monthly_income add = var:aqoa_personal_gold }
		}
	}
}

olympia_calculate_dependent_income = {
	#Now we look for any families that would also benefit from this income

	if = {
		limit = { NOT = { has_character_flag = olympia_income_dependent } }
		aqoa_gold_to_xp_adjustment = yes
		aqoa_tribal_xp_adjustment = yes
	}

	#Pool spouse income
	if = {
		limit = {
			is_married = yes
			gold >= 10
		}
		
		save_scope_as = primary_spouse
		
		# Both spouses get the pooled amount
		every_spouse = {
			limit = { is_ruler = no }
			set_variable = {
				name = aqoa_monthly_income
				value = scope:primary_spouse.var:aqoa_monthly_income
			}
			amfac_calculate_affluence_xp = yes
		}
	}

	#Children next
	if = {
		limit = {
			NOT = { has_character_flag = olympia_income_dependent }
			has_variable = aqoa_monthly_income
			any_parent = {
				is_alive = yes
				liege ?= scope:host
				has_variable = aqoa_monthly_income
				var:aqoa_monthly_income > prev.var:aqoa_monthly_income
			}
		}
		random_parent = {
			limit = {
				is_alive = yes
				liege ?= scope:host
				location = root.location
				has_variable = aqoa_monthly_income
				gold >= 10
				var:aqoa_monthly_income > prev.var:aqoa_monthly_income
			}
			save_scope_as = earning_parent
		}
		set_variable = { 
			name = aqoa_monthly_income 
			value = scope:earning_parent.var:aqoa_monthly_income
		}
		amfac_calculate_affluence_xp = yes
	}
	
	#Siblings next, usually for unmarried sisters
	if = {
		limit = {
			NOT = { has_character_flag = olympia_income_dependent }
			has_variable = aqoa_monthly_income
			any_sibling = {
				is_alive = yes
				liege = scope:host
				gold >= 10
				has_variable = aqoa_monthly_income
				var:aqoa_monthly_income > prev.var:aqoa_monthly_income
			}
		}
		random_sibling = {
			limit = {
				is_alive = yes
				liege = scope:host
				gold >= 10
				has_variable = aqoa_monthly_income
				var:aqoa_monthly_income > prev.var:aqoa_monthly_income
			}
			save_scope_as = earning_sibling
		}
		set_variable = { 
			name = aqoa_monthly_income 
			value = scope:earning_sibling.var:aqoa_monthly_income
		}
		amfac_calculate_affluence_xp = yes
	}
	
	#Parents next, usually for the elderly being supported by their children
	if = {
		limit = {
			NOT = { has_character_flag = olympia_income_dependent }
			has_variable = aqoa_monthly_income
			any_child = {
				is_alive = yes
				liege = scope:host
				gold >= 10
				has_variable = aqoa_monthly_income
				var:aqoa_monthly_income > prev.var:aqoa_monthly_income
			}
		}
		random_child = {
			limit = {
				is_alive = yes
				liege = scope:host
				gold >= 10
				has_variable = aqoa_monthly_income
				var:aqoa_monthly_income > prev.var:aqoa_monthly_income
			}
			save_scope_as = earning_child
		}
		set_variable = { 
			name = aqoa_monthly_income 
			value = scope:earning_child.var:aqoa_monthly_income
		}
		amfac_calculate_affluence_xp = yes
	}
	
	#Last check, see if they are in prison, no money for you
	if = {
		limit = {
			is_imprisoned = yes
		}
		set_variable = { 
			name = aqoa_monthly_income 
			value = 0
		}
		add_trait_xp = { trait = olympia_class_tier value = -100 }
	}

	amfac_calculate_affluence_xp = yes

	#remove_variable = aqoa_personal_gold
}

amfac_calculate_affluence_xp = {
	#Reset the Affluence XP
	add_trait_xp = { trait = olympia_class_tier value = -100 }
	
	#Time to finally add it to the trait as XP
	if = {
		limit = {
			var:aqoa_monthly_income >= 0.3
		}

		while = {
			count = 100
			limit = {
				has_trait_xp = { trait = olympia_class_tier value < var:aqoa_monthly_income }
			}
			add_trait_xp = { trait = olympia_class_tier value = 1 }
		}
	}
}

amfac_death_inheritance = {
	if = {
		limit = {
			gold > 10
			is_landed_or_landless_administrative = no
			is_clergy = no
			is_ai = yes
		}
		
		save_scope_as = dead_one
		
		set_variable = { name = death_gold_to_inherit value = gold }
		
		#To Spouse First
		if = {
			limit = {
				exists = root.primary_spouse
			}
			ROOT = {
				pay_short_term_gold = {
					target = root.primary_spouse
					gold = var:death_gold_to_inherit
				}
			}
		}
		
		#If no spouse, then to children, and if not, then siblings
		else_if = {
			limit = {
				OR = {
					any_child = {
						count > 0
						is_alive = yes
					}
					any_sibling = {
						count > 0
						is_alive = yes
					}
				}
			}
			
			set_variable = { name = characters_to_inherit value = 0 }
			
			#Let's check inheritance rules
			
			#Male Children First
			if = {
				limit = {
					any_child = { is_male = yes }
					liege ?= {
						OR = {
							has_realm_law = male_only_law
							has_realm_law = male_preference_law
						}
					}
				}
				
				#Male Only Children
				every_child = {
					limit = {
						is_alive = yes
						is_female = no
					}
					add_to_list = heirs
					ROOT = {
						change_variable = {
							name = characters_to_inherit
							add = 1
						}
					}
				}
			}
			else_if = {
				limit = {
					any_child = { is_male = no }
					liege ?= {
						has_realm_law = male_preference_law
					}
				}
				
				#Female Children
				every_child = {
					limit = {
						is_alive = yes
					}
					add_to_list = heirs
					ROOT = {
						change_variable = {
							name = characters_to_inherit
							add = 1
						}
					}
				}
			}
			else_if = {
				limit = {
					any_child = { is_male = no }
					any_sibling = { is_male = yes }
					liege ?= {
						has_realm_law = male_only_law
					}
				}
				
				#Brothers
				every_sibling = {
					limit = {
						is_alive = yes
					}
					add_to_list = heirs
					ROOT = {
						change_variable = {
							name = characters_to_inherit
							add = 1
						}
					}
				}
			}
			
			#Female Preference laws instead
			else_if = {
				limit = {
					any_child = { is_female = yes }
					liege ?= {
						OR = {
							has_realm_law = female_only_law
							has_realm_law = female_preference_law
						}
					}
				}
				
				#Female Only Children
				every_child = {
					limit = {
						is_alive = yes
						is_female = yes
					}
					add_to_list = heirs
					ROOT = {
						change_variable = {
							name = characters_to_inherit
							add = 1
						}
					}
				}
			}
			else_if = {
				limit = {
					any_child = { is_female = no }
					liege ?= {
						has_realm_law = female_preference_law
					}
				}
				
				#Male Children
				every_child = {
					limit = {
						is_alive = yes
					}
					add_to_list = heirs
					ROOT = {
						change_variable = {
							name = characters_to_inherit
							add = 1
						}
					}
				}
			}
			else_if = {
				limit = {
					any_child = { is_female = no }
					any_sibling = { is_female = yes }
					liege ?= {
						has_realm_law = female_only_law
					}
				}
				
				#Sisters
				every_sibling = {
					limit = {
						is_alive = yes
					}
					add_to_list = heirs
					ROOT = {
						change_variable = {
							name = characters_to_inherit
							add = 1
						}
					}
				}
			}
		}
		
		#If no children or siblings, then to parents
		else_if = {
			limit = {
				any_parent = {
					count > 0
					is_alive = yes
				}
			}
			
			set_variable = { name = characters_to_inherit value = 0 }
			
			every_parent = {
				limit = { is_alive = yes }
				add_to_list = heirs
				ROOT = {
					change_variable = {
						name = characters_to_inherit
						add = 1
					}
				}
			}
		}
		
		change_variable = { name = death_gold_to_inherit divide = var:characters_to_inherit }
		
		every_in_list = {
			list = heirs
			ROOT = {
				pay_short_term_gold = {
					target = PREV
					gold = var:death_gold_to_inherit
				}
			}
		}
	}
}